name: QEMU CI/CD - TCG Mode (GitHub-Hosted)

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  qemu-test-tcg:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    name: QEMU Integration Test (TCG Software Emulation)
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install QEMU and tools
        run: |
          echo "=== Installing QEMU and utilities ==="
          sudo apt-get update
          sudo apt-get install -y \
            qemu-system-i386 \
            qemu-utils \
            cloud-image-utils \
            socat \
            python3 \
            python3-pip \
            telnet \
            expect
          
          # Verify installation
          qemu-system-i386 --version
          cloud-localds --help | head -3
          
          echo "=== Installation complete ==="
      
      - name: Prepare VM directories
        run: |
          echo "=== Creating VM workspace ==="
          mkdir -p vm/{images,seed,qmp,logs}
          ls -la vm/
      
      - name: Download or prepare Hurd image
        id: prepare-image
        run: |
          echo "=== Checking for Debian GNU/Hurd image ==="
          
          # Check if image exists in repository (unlikely due to size)
          if [ -f "debian-hurd-i386.qcow2" ]; then
            echo "Found image in repository"
            cp debian-hurd-i386.qcow2 vm/images/disk.qcow2
            echo "image_available=true" >> $GITHUB_OUTPUT
          else
            echo "Image not in repository (expected)"
            echo "image_available=false" >> $GITHUB_OUTPUT
            
            # For CI, we'll create a minimal test image
            # In production, download actual Debian GNU/Hurd image
            echo "Creating minimal test image for CI validation..."
            qemu-img create -f qcow2 vm/images/disk.qcow2 2G
          fi
          
          qemu-img info vm/images/disk.qcow2
      
      - name: Create cloud-init configuration
        run: |
          echo "=== Creating cloud-init configuration ==="
          
          # User data configuration
          cat > vm/seed/user-data.yaml <<'USERDATA'
          #cloud-config
          users:
            - name: ci
              gecos: CI Test User
              sudo: ALL=(ALL) NOPASSWD:ALL
              groups: sudo
              shell: /bin/bash
              lock_passwd: false
              # Password: citest123
              passwd: $6$rounds=4096$saltsalt$4HvgSN.rIxzX8n5pVXH2RHJ8xwVKJvN8JvBhKxKfvWU2PmUJGZvIJUJvJKfvWU2PmUJGZvI
              ssh_authorized_keys:
                - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGHPZc1234567890abcdefghijklmnop ci@github-ci
          
          package_update: false
          package_upgrade: false
          
          runcmd:
            - systemctl enable ssh || true
            - systemctl start ssh || true
            - echo "Cloud-init completed at $(date)" > /var/log/cloud-init-complete
          USERDATA
          
          # Meta data
          cat > vm/seed/meta-data.yaml <<'METADATA'
          instance-id: github-ci-$(date +%s)
          local-hostname: hurd-ci-test
          METADATA
          
          # Create seed ISO
          cloud-localds vm/seed/seed.iso vm/seed/user-data.yaml vm/seed/meta-data.yaml
          
          ls -lh vm/seed/
          echo "=== Cloud-init configuration created ==="
      
      - name: Launch QEMU (background)
        run: |
          echo "=== Launching QEMU in TCG mode ==="
          
          # Launch QEMU in background with comprehensive logging
          nohup qemu-system-i386 \
            -machine q35,accel=tcg \
            -cpu qemu64 \
            -smp 2 \
            -m 2048 \
            -drive if=virtio,file=vm/images/disk.qcow2,format=qcow2,cache=writeback \
            -drive if=virtio,media=cdrom,file=vm/seed/seed.iso,readonly=on \
            -netdev user,id=net0,hostfwd=tcp::2222-:22,hostfwd=tcp::8080-:80 \
            -device virtio-net-pci,netdev=net0 \
            -nographic \
            -chardev file,id=serlog,path=vm/logs/serial.log \
            -serial chardev:serlog \
            -serial telnet:127.0.0.1:5555,server,nowait \
            -qmp unix:vm/qmp/qmp.sock,server=on,wait=off \
            -monitor unix:vm/qmp/monitor.sock,server=on,nowait \
            -rtc base=utc,clock=host \
            -no-reboot \
            -d guest_errors \
            -D vm/logs/qemu.log \
            > vm/logs/qemu-stdout.log 2>&1 &
          
          # Save PID for cleanup
          echo $! > vm/qemu.pid
          
          echo "QEMU PID: $(cat vm/qemu.pid)"
          sleep 5
          
          # Verify QEMU is running
          if ps -p $(cat vm/qemu.pid) > /dev/null; then
            echo "✓ QEMU process is running"
          else
            echo "✗ QEMU process failed to start"
            cat vm/logs/qemu-stdout.log
            exit 1
          fi
      
      - name: Wait for QEMU initialization
        timeout-minutes: 3
        run: |
          echo "=== Waiting for QEMU to initialize ==="
          
          # Wait for QMP socket
          for i in {1..30}; do
            if [ -S vm/qmp/qmp.sock ]; then
              echo "✓ QMP socket available"
              break
            fi
            echo "Waiting for QMP socket... ($i/30)"
            sleep 2
          done
          
          if [ ! -S vm/qmp/qmp.sock ]; then
            echo "✗ QMP socket not created"
            exit 1
          fi
          
          # Test QMP connection
          echo '{"execute":"query-status"}' | python3 scripts/qmp-helper.py || true
      
      - name: Monitor boot process
        timeout-minutes: 5
        continue-on-error: true  # May timeout if actual Hurd image not available
        run: |
          echo "=== Monitoring boot process ==="
          
          # Monitor serial log for boot progress
          timeout 120 bash -c '
            while true; do
              if [ -f vm/logs/serial.log ]; then
                # Check for common boot indicators
                if grep -qi "login:" vm/logs/serial.log 2>/dev/null; then
                  echo "✓ Login prompt detected"
                  exit 0
                fi
                if grep -qi "GNU Mach" vm/logs/serial.log 2>/dev/null; then
                  echo "✓ GNU Mach kernel detected"
                fi
                if grep -qi "GRUB" vm/logs/serial.log 2>/dev/null; then
                  echo "✓ GRUB bootloader detected"
                fi
              fi
              sleep 5
            done
          ' || echo "Boot monitoring timed out (expected for test image)"
      
      - name: Test QMP automation
        run: |
          echo "=== Testing QMP automation ==="
          
          # Query VM status
          echo "Querying VM status..."
          echo '{"execute":"query-status"}' | python3 scripts/qmp-helper.py | tee vm/logs/qmp-status.json
          
          # Query CPU info
          echo "Querying CPU info..."
          echo '{"execute":"query-cpus-fast"}' | python3 scripts/qmp-helper.py | tee vm/logs/qmp-cpus.json || true
          
          # Query block devices
          echo "Querying block devices..."
          echo '{"execute":"query-block"}' | python3 scripts/qmp-helper.py | tee vm/logs/qmp-block.json || true
          
          echo "=== QMP automation test complete ==="
      
      - name: Test serial console access
        continue-on-error: true
        run: |
          echo "=== Testing serial console access ==="
          
          # Test telnet connection (non-interactive check)
          timeout 5 bash -c '
            (echo "test" | telnet localhost 5555) &
            sleep 2
            echo "Serial console connection tested"
          ' || echo "Serial console test skipped"
      
      - name: Collect diagnostic information
        if: always()
        run: |
          echo "=== Collecting diagnostic information ==="
          
          # QEMU process info
          echo "QEMU process status:"
          if [ -f vm/qemu.pid ]; then
            ps aux | grep $(cat vm/qemu.pid) || echo "QEMU process not running"
          fi
          
          # QMP final status
          echo "Final VM status:"
          echo '{"execute":"query-status"}' | python3 scripts/qmp-helper.py || echo "QMP unavailable"
          
          # Serial log summary
          echo "Serial log summary (last 50 lines):"
          tail -50 vm/logs/serial.log 2>/dev/null || echo "No serial log"
          
          # QEMU log summary
          echo "QEMU log summary (last 30 lines):"
          tail -30 vm/logs/qemu.log 2>/dev/null || echo "No QEMU log"
      
      - name: Teardown QEMU
        if: always()
        run: |
          echo "=== Shutting down QEMU ==="
          
          if [ -f vm/qemu.pid ]; then
            QEMU_PID=$(cat vm/qemu.pid)
            
            # Try graceful shutdown via QMP
            echo '{"execute":"system_powerdown"}' | python3 scripts/qmp-helper.py || true
            sleep 5
            
            # Force kill if still running
            if ps -p $QEMU_PID > /dev/null 2>&1; then
              echo "Forcing QEMU termination..."
              kill -TERM $QEMU_PID || true
              sleep 2
              kill -KILL $QEMU_PID 2>/dev/null || true
            fi
            
            echo "✓ QEMU shutdown complete"
          fi
      
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qemu-tcg-test-logs
          path: |
            vm/logs/*.log
            vm/logs/*.json
          retention-days: 7
      
      - name: Generate test summary
        if: always()
        run: |
          echo "## QEMU CI/CD Test Summary (TCG Mode)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- Emulation: TCG (Software)" >> $GITHUB_STEP_SUMMARY
          echo "- CPU: qemu64, 2 cores" >> $GITHUB_STEP_SUMMARY
          echo "- Memory: 2048 MB" >> $GITHUB_STEP_SUMMARY
          echo "- Machine: q35" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**Test Results:**" >> $GITHUB_STEP_SUMMARY
          if [ -f vm/logs/qmp-status.json ]; then
            echo "- ✓ QMP automation: Working" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ✗ QMP automation: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -S vm/qmp/qmp.sock ]; then
            echo "- ✓ QMP socket: Created" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ✗ QMP socket: Not created" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f vm/logs/serial.log ] && [ -s vm/logs/serial.log ]; then
            echo "- ✓ Serial console: Output captured" >> $GITHUB_STEP_SUMMARY
            echo "- Serial log size: $(wc -l < vm/logs/serial.log) lines" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ⚠ Serial console: No output" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Notes:**" >> $GITHUB_STEP_SUMMARY
          echo "- This test validates QEMU automation infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "- Full Hurd boot requires actual Debian GNU/Hurd image" >> $GITHUB_STEP_SUMMARY
          echo "- Download image with: \`./scripts/download-image.sh\`" >> $GITHUB_STEP_SUMMARY
