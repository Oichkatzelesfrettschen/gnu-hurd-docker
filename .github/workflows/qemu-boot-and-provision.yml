name: QEMU GNU/Hurd Boot & Provision

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  boot-and-provision:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Disable KVM in compose for CI
        run: |
          sed -i 's@- /dev/kvm@# - /dev/kvm (disabled in CI)@' docker-compose.yml || true

      - name: Install host tooling (sshpass, telnet, expect, netcat)
        run: sudo apt-get update && sudo apt-get install -y sshpass telnet expect netcat-openbsd

      - name: Build images
        run: docker compose build

      - name: Start GUI profile service
        run: docker compose up -d gnu-hurd-dev

      - name: Start CLI profile service
        run: docker compose --profile cli up -d gnu-hurd-cli

      - name: Show running containers
        run: docker ps -a

      - name: Wait for serial ports to open
        run: |
          for p in 5555 5556; do
            echo "Waiting for port $p ...";
            for i in {1..120}; do
              if nc -z 127.0.0.1 $p; then echo "Port $p up"; break; fi; sleep 2; done;
          done

      - name: Initial boot grace period (Hurd slow boot)
        run: sleep 600

      - name: Provision GUI via serial (SSH enable + root pwd)
        env:
          SERIAL_PORT: "5555"
        run: |
          for i in {1..3}; do
            printf '\n' | bash scripts/install-ssh-hurd.sh && break || sleep 60;
          done

      - name: Provision CLI via serial (SSH enable + root pwd)
        env:
          SERIAL_PORT: "5556"
        run: |
          for i in {1..3}; do
            printf '\n' | bash scripts/install-ssh-hurd.sh && break || sleep 60;
          done

      - name: Fix sources (GUI)
        run: ROOT_PASS=root bash scripts/fix-sources-hurd.sh -p 2222 || true

      - name: Fix sources (CLI)
        run: ROOT_PASS=root bash scripts/fix-sources-hurd.sh -p 2223 || true

      - name: SSH test GUI
        run: |
          sshpass -p root ssh -o StrictHostKeyChecking=no -o ConnectTimeout=15 -p 2222 root@127.0.0.1 'echo GUI_SSH_OK && uname -a' || (echo 'GUI SSH FAILED' && exit 1)

      - name: SSH test CLI
        run: |
          sshpass -p root ssh -o StrictHostKeyChecking=no -o ConnectTimeout=15 -p 2223 root@127.0.0.1 'echo CLI_SSH_OK && uname -a' || (echo 'CLI SSH FAILED' && exit 1)

      - name: Collect QEMU and container logs
        if: always()
        run: |
          mkdir -p artifacts
          docker logs gnu-hurd-dev > artifacts/docker-gui.log 2>&1 || true
          docker logs gnu-hurd-cli > artifacts/docker-cli.log 2>&1 || true
          docker cp gnu-hurd-dev:/tmp/qemu.log artifacts/qemu-gui.log || true
          docker cp gnu-hurd-cli:/tmp/qemu.log artifacts/qemu-cli.log || true
          echo "info status" | docker exec -i gnu-hurd-dev socat - UNIX-CONNECT:/qmp/monitor.sock > artifacts/monitor-gui.txt 2>&1 || true
          echo "info status" | docker exec -i gnu-hurd-cli socat - UNIX-CONNECT:/qmp/monitor.sock > artifacts/monitor-cli.txt 2>&1 || true
          ls -l artifacts

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
            name: qemu-logs
            path: artifacts

      - name: Dump sshd config (GUI)
        if: always()
        run: sshpass -p root ssh -o StrictHostKeyChecking=no -p 2222 root@127.0.0.1 'grep -E "^(PermitRootLogin|PasswordAuthentication|UsePAM)" /etc/ssh/sshd_config' || true

      - name: Dump sshd config (CLI)
        if: always()
        run: sshpass -p root ssh -o StrictHostKeyChecking=no -p 2223 root@127.0.0.1 'grep -E "^(PermitRootLogin|PasswordAuthentication|UsePAM)" /etc/ssh/sshd_config' || true
