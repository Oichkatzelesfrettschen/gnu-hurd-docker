name: QEMU CI/CD - KVM Mode (Self-Hosted)

on:
  workflow_dispatch:  # Manual trigger only for self-hosted runners
    inputs:
      memory:
        description: 'RAM allocation in MB'
        required: false
        default: '4096'
      cpus:
        description: 'Number of CPU cores'
        required: false
        default: '4'
      timeout:
        description: 'Boot timeout in minutes'
        required: false
        default: '10'

jobs:
  qemu-test-kvm:
    # This job requires a self-hosted runner with KVM support
    # Label the runner with: self-hosted, linux, x64, kvm
    runs-on: [self-hosted, linux, x64, kvm]
    timeout-minutes: 60
    name: QEMU Integration Test (KVM Acceleration)
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Verify KVM availability
        run: |
          echo "=== Verifying KVM support ==="
          
          # Check /dev/kvm exists and is accessible
          if [ ! -e /dev/kvm ]; then
            echo "✗ /dev/kvm does not exist"
            echo "KVM kernel module may not be loaded"
            exit 1
          fi
          
          if [ ! -r /dev/kvm ] || [ ! -w /dev/kvm ]; then
            echo "✗ /dev/kvm not accessible (check permissions)"
            ls -l /dev/kvm
            echo "Add user to kvm group: sudo usermod -aG kvm $(whoami)"
            exit 1
          fi
          
          echo "✓ /dev/kvm is accessible"
          ls -l /dev/kvm
          
          # Check CPU virtualization support
          if grep -Eq '(vmx|svm)' /proc/cpuinfo; then
            echo "✓ CPU supports virtualization"
            grep -E '(vmx|svm)' /proc/cpuinfo | head -1
          else
            echo "✗ CPU does not support virtualization"
            exit 1
          fi
          
          # Check KVM module
          if lsmod | grep -q kvm; then
            echo "✓ KVM kernel module loaded"
            lsmod | grep kvm
          else
            echo "✗ KVM kernel module not loaded"
            exit 1
          fi
          
          echo "=== KVM verification complete ==="
      
      - name: Install QEMU and tools (if needed)
        run: |
          echo "=== Ensuring QEMU and tools are installed ==="
          
          # Check if qemu-system-i386 is installed
          if ! command -v qemu-system-i386 &> /dev/null; then
            echo "Installing QEMU..."
            sudo apt-get update
            sudo apt-get install -y qemu-system-i386 qemu-utils cloud-image-utils socat python3 telnet
          else
            echo "✓ QEMU already installed"
            qemu-system-i386 --version | head -1
          fi
          
          # Verify other tools
          cloud-localds --version 2>/dev/null || sudo apt-get install -y cloud-image-utils
          python3 --version
          
          echo "=== Tool verification complete ==="
      
      - name: Prepare VM environment
        run: |
          echo "=== Preparing VM environment ==="
          
          # Create directories
          mkdir -p vm/{images,seed,qmp,logs}
          
          # Configuration from inputs
          echo "QEMU_RAM=${{ github.event.inputs.memory || '4096' }}" > vm/config.env
          echo "QEMU_SMP=${{ github.event.inputs.cpus || '4' }}" >> vm/config.env
          echo "BOOT_TIMEOUT=${{ github.event.inputs.timeout || '10' }}" >> vm/config.env
          
          cat vm/config.env
          source vm/config.env
          
          echo "Configuration:"
          echo "  RAM: ${QEMU_RAM} MB"
          echo "  CPUs: ${QEMU_SMP}"
          echo "  Timeout: ${BOOT_TIMEOUT} minutes"
      
      - name: Download or prepare Hurd image
        run: |
          echo "=== Preparing Debian GNU/Hurd image ==="
          
          # Check if image exists locally
          if [ -f "debian-hurd-i386.qcow2" ]; then
            echo "✓ Using existing image from repository"
            cp debian-hurd-i386.qcow2 vm/images/disk.qcow2
          elif [ -f "$HOME/hurd-images/debian-hurd-i386.qcow2" ]; then
            echo "✓ Using cached image from runner"
            cp $HOME/hurd-images/debian-hurd-i386.qcow2 vm/images/disk.qcow2
          else
            echo "Downloading Debian GNU/Hurd image..."
            ./scripts/download-image.sh
            # Assuming script downloads to current directory
            if [ -f "debian-hurd-i386.qcow2" ]; then
              cp debian-hurd-i386.qcow2 vm/images/disk.qcow2
              # Cache for future runs
              mkdir -p $HOME/hurd-images
              cp debian-hurd-i386.qcow2 $HOME/hurd-images/
            else
              echo "✗ Failed to download image"
              exit 1
            fi
          fi
          
          # Verify image
          qemu-img info vm/images/disk.qcow2
          qemu-img check vm/images/disk.qcow2
      
      - name: Create cloud-init configuration
        run: |
          echo "=== Creating cloud-init configuration ==="
          
          # Generate SSH key for this run
          ssh-keygen -t ed25519 -f vm/ci-key -N "" -C "ci@self-hosted-runner"
          
          # User data with generated SSH key
          cat > vm/seed/user-data.yaml <<EOF
          #cloud-config
          users:
            - name: ci
              gecos: CI Test User
              sudo: ALL=(ALL) NOPASSWD:ALL
              groups: sudo
              shell: /bin/bash
              lock_passwd: false
              passwd: \$6\$rounds=4096\$salt\$hashedpassword
              ssh_authorized_keys:
                - $(cat vm/ci-key.pub)
          
          package_update: false
          package_upgrade: false
          
          packages:
            - openssh-server
            - build-essential
            - git
          
          runcmd:
            - systemctl enable ssh
            - systemctl start ssh
            - echo "Cloud-init completed at \$(date)" > /var/log/cloud-init-complete
            - echo "Ready for testing" > /tmp/ready
          EOF
          
          # Meta data
          cat > vm/seed/meta-data.yaml <<EOF
          instance-id: self-hosted-kvm-$(date +%s)
          local-hostname: hurd-kvm-test
          EOF
          
          # Create seed ISO
          cloud-localds vm/seed/seed.iso vm/seed/user-data.yaml vm/seed/meta-data.yaml
          
          ls -lh vm/seed/
      
      - name: Launch QEMU with KVM
        run: |
          echo "=== Launching QEMU with KVM acceleration ==="
          
          source vm/config.env
          
          # Launch QEMU with KVM
          nohup qemu-system-i386 \
            -enable-kvm \
            -cpu host \
            -machine q35,accel=kvm \
            -smp ${QEMU_SMP} \
            -m ${QEMU_RAM} \
            -drive if=virtio,file=vm/images/disk.qcow2,format=qcow2,cache=writeback,aio=threads \
            -drive if=virtio,media=cdrom,file=vm/seed/seed.iso,readonly=on \
            -netdev user,id=net0,hostfwd=tcp::2222-:22,hostfwd=tcp::8080-:80 \
            -device virtio-net-pci,netdev=net0 \
            -nographic \
            -chardev file,id=serlog,path=vm/logs/serial.log \
            -serial chardev:serlog \
            -serial telnet:127.0.0.1:5555,server,nowait \
            -qmp unix:vm/qmp/qmp.sock,server=on,wait=off \
            -monitor unix:vm/qmp/monitor.sock,server=on,nowait \
            -rtc base=utc,clock=host \
            -no-reboot \
            -d guest_errors \
            -D vm/logs/qemu.log \
            > vm/logs/qemu-stdout.log 2>&1 &
          
          echo $! > vm/qemu.pid
          
          echo "QEMU PID: $(cat vm/qemu.pid)"
          sleep 3
          
          # Verify QEMU is running
          if ps -p $(cat vm/qemu.pid) > /dev/null; then
            echo "✓ QEMU process is running with KVM"
          else
            echo "✗ QEMU failed to start"
            cat vm/logs/qemu-stdout.log
            exit 1
          fi
          
          # Verify KVM is being used
          if grep -q "kvm" /proc/$(cat vm/qemu.pid)/cmdline; then
            echo "✓ KVM acceleration confirmed"
          fi
      
      - name: Wait for system boot
        timeout-minutes: ${{ github.event.inputs.timeout || 10 }}
        run: |
          echo "=== Waiting for system to boot ==="
          
          source vm/config.env
          TIMEOUT=$((BOOT_TIMEOUT * 60))  # Convert to seconds
          START_TIME=$(date +%s)
          
          while true; do
            ELAPSED=$(($(date +%s) - START_TIME))
            
            if [ $ELAPSED -gt $TIMEOUT ]; then
              echo "✗ Boot timeout after ${BOOT_TIMEOUT} minutes"
              exit 1
            fi
            
            # Check for login prompt in serial log
            if grep -qi "login:" vm/logs/serial.log 2>/dev/null; then
              echo "✓ Login prompt detected after ${ELAPSED} seconds"
              break
            fi
            
            # Progress indicators
            if grep -qi "GNU Mach" vm/logs/serial.log 2>/dev/null; then
              echo "  GNU Mach kernel booting..."
            fi
            
            echo "Waiting for boot... (${ELAPSED}/${TIMEOUT}s)"
            sleep 10
          done
      
      - name: Wait for SSH service
        timeout-minutes: 5
        run: |
          echo "=== Waiting for SSH service ==="
          
          for i in {1..60}; do
            if ssh -o StrictHostKeyChecking=no \
                   -o UserKnownHostsFile=/dev/null \
                   -o ConnectTimeout=2 \
                   -i vm/ci-key \
                   -p 2222 \
                   ci@localhost \
                   true 2>/dev/null; then
              echo "✓ SSH service is ready after $((i*5)) seconds"
              break
            fi
            
            if [ $i -eq 60 ]; then
              echo "✗ SSH timeout"
              exit 1
            fi
            
            echo "Waiting for SSH... ($i/60)"
            sleep 5
          done
      
      - name: Run system tests
        run: |
          echo "=== Running system tests in guest ==="
          
          SSH_CMD="ssh -o StrictHostKeyChecking=no \
                       -o UserKnownHostsFile=/dev/null \
                       -i vm/ci-key \
                       -p 2222 \
                       ci@localhost"
          
          # System information
          echo "System information:"
          $SSH_CMD 'uname -a'
          
          # Kernel version
          echo "Kernel version:"
          $SSH_CMD 'uname -r' || true
          
          # Memory info
          echo "Memory information:"
          $SSH_CMD 'free -h' || true
          
          # Disk info
          echo "Disk information:"
          $SSH_CMD 'df -h' || true
          
          # CPU info
          echo "CPU information:"
          $SSH_CMD 'nproc' || true
          
          # Package manager test
          echo "Testing package manager:"
          $SSH_CMD 'which apt-get && apt-get --version' || true
          
          # Compiler test
          echo "Testing compiler:"
          $SSH_CMD 'gcc --version' || true
          
          # Create test program
          echo "Compiling test program:"
          $SSH_CMD 'cat > /tmp/test.c << "CEOF"
          #include <stdio.h>
          int main() {
              printf("Hello from GNU/Hurd!\n");
              return 0;
          }
          CEOF'
          
          $SSH_CMD 'gcc /tmp/test.c -o /tmp/test && /tmp/test' || true
      
      - name: Performance benchmarks
        continue-on-error: true
        run: |
          echo "=== Running performance benchmarks ==="
          
          SSH_CMD="ssh -o StrictHostKeyChecking=no \
                       -o UserKnownHostsFile=/dev/null \
                       -i vm/ci-key \
                       -p 2222 \
                       ci@localhost"
          
          # Simple CPU benchmark
          echo "CPU benchmark (computing π):"
          $SSH_CMD 'time echo "scale=1000; 4*a(1)" | bc -l' || true
          
          # Disk I/O benchmark
          echo "Disk I/O benchmark:"
          $SSH_CMD 'dd if=/dev/zero of=/tmp/testfile bs=1M count=100 2>&1 | grep copied' || true
          
          # Memory allocation test
          echo "Memory test:"
          $SSH_CMD 'free -h' || true
      
      - name: QMP automation tests
        run: |
          echo "=== Testing QMP automation ==="
          
          # Query status
          echo "VM Status:"
          echo '{"execute":"query-status"}' | python3 scripts/qmp-helper.py
          
          # Query KVM info
          echo "KVM Info:"
          echo '{"execute":"query-kvm"}' | python3 scripts/qmp-helper.py
          
          # Query CPU info
          echo "CPU Info:"
          echo '{"execute":"query-cpus-fast"}' | python3 scripts/qmp-helper.py || true
          
          # Query memory
          echo "Memory Info:"
          echo '{"execute":"query-memory-size-summary"}' | python3 scripts/qmp-helper.py || true
      
      - name: Collect artifacts
        if: always()
        run: |
          echo "=== Collecting test artifacts ==="
          
          # Collect all logs
          tar czf vm-artifacts.tar.gz vm/logs/
          
          # System info from guest (if still accessible)
          SSH_CMD="ssh -o StrictHostKeyChecking=no \
                       -o UserKnownHostsFile=/dev/null \
                       -o ConnectTimeout=5 \
                       -i vm/ci-key \
                       -p 2222 \
                       ci@localhost"
          
          $SSH_CMD 'dmesg > /tmp/dmesg.log' 2>/dev/null || true
          $SSH_CMD 'cat /var/log/cloud-init-output.log > /tmp/cloud-init.log' 2>/dev/null || true
          
          echo "Artifacts collected"
      
      - name: Graceful shutdown
        if: always()
        run: |
          echo "=== Shutting down VM gracefully ==="
          
          # Try SSH shutdown first
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o ConnectTimeout=5 \
              -i vm/ci-key \
              -p 2222 \
              ci@localhost \
              'sudo shutdown -h now' 2>/dev/null || true
          
          sleep 10
          
          # Try QMP shutdown
          echo '{"execute":"system_powerdown"}' | python3 scripts/qmp-helper.py || true
          
          sleep 10
          
          # Force kill if needed
          if [ -f vm/qemu.pid ] && ps -p $(cat vm/qemu.pid) > /dev/null 2>&1; then
            echo "Force terminating QEMU..."
            kill -TERM $(cat vm/qemu.pid) || true
            sleep 2
            kill -KILL $(cat vm/qemu.pid) 2>/dev/null || true
          fi
          
          echo "✓ Shutdown complete"
      
      - name: Cleanup
        if: always()
        run: |
          echo "=== Cleanup ==="
          
          # Remove sensitive keys
          rm -f vm/ci-key vm/ci-key.pub
          
          # Clean up temporary files
          rm -f vm/seed/seed.iso
          
          echo "✓ Cleanup complete"
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qemu-kvm-test-results
          path: |
            vm/logs/*.log
            vm/logs/*.json
            vm-artifacts.tar.gz
          retention-days: 14
      
      - name: Generate test summary
        if: always()
        run: |
          echo "## QEMU CI/CD Test Summary (KVM Mode)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- Acceleration: KVM (Hardware)" >> $GITHUB_STEP_SUMMARY
          echo "- CPU: host, ${{ github.event.inputs.cpus || '4' }} cores" >> $GITHUB_STEP_SUMMARY
          echo "- Memory: ${{ github.event.inputs.memory || '4096' }} MB" >> $GITHUB_STEP_SUMMARY
          echo "- Machine: q35 with KVM" >> $GITHUB_STEP_SUMMARY
          echo "- Runner: Self-hosted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "**Performance:**" >> $GITHUB_STEP_SUMMARY
          if [ -f vm/logs/serial.log ]; then
            BOOT_TIME=$(grep -m1 "login:" vm/logs/serial.log | awk '{print $1}' || echo "N/A")
            echo "- Boot time: ${BOOT_TIME}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Results:**" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ KVM acceleration: Enabled" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ System boot: Success" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ SSH access: Working" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ QMP automation: Working" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifacts:**" >> $GITHUB_STEP_SUMMARY
          echo "- Serial console logs" >> $GITHUB_STEP_SUMMARY
          echo "- QEMU debug logs" >> $GITHUB_STEP_SUMMARY
          echo "- QMP query results" >> $GITHUB_STEP_SUMMARY
          echo "- Performance benchmark results" >> $GITHUB_STEP_SUMMARY
