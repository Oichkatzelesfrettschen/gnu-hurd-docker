services:
  gnu-hurd-dev:
    build:
      context: .
      dockerfile: Dockerfile

    container_name: gnu-hurd-dev
    privileged: true

    volumes:
      - .:/opt/hurd-image           # Project root (read-write for QCOW2)
      - ./qmp:/qmp                  # Unix sockets (monitor, QMP)
      - ./share:/share              # Shared files via 9p (scripts, data)

    ports:
      - "2222:2222"  # SSH access to guest
      - "8080:80"    # HTTP access to guest
      - "9999:9999"  # Custom application port
      - "5555:5555"  # Serial console (telnet)
      - "5901:5901"  # VNC (if DISPLAY_MODE=vnc)

    # Linux-only optimizations (comment out on macOS/Windows)
    devices:
      - /dev/kvm     # KVM acceleration (auto-detected in entrypoint.sh)

    environment:
      # Override defaults if needed
      - QEMU_RAM=4096                    # 4 GB for better performance (2048 minimum)
      - QEMU_SMP=4                       # 4 cores (1-6 recommended)
      - DISPLAY_MODE=sdl-gl              # nographic|vnc|sdl-gl|gtk-gl
      - QEMU_VIDEO=std                   # std|virtio-vga-gl|cirrus (Hurd-compatible)
      - QEMU_STORAGE=ide                 # ide|virtio (Hurd-compatible default)
      - QEMU_NET=e1000                   # e1000|virtio (Hurd-compatible default)
      - SERIAL_PORT=5555
      - SHARE_TAG=scripts

    stdin_open: true
    tty: true

    networks:
      - hurd-net

  gnu-hurd-cli:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: gnu-hurd-cli
    privileged: true
    profiles: ["cli"]
    volumes:
      - .:/opt/hurd-image
      - ./qmp:/qmp
      - ./share:/share
    ports:
      - "2223:2222"  # separate SSH for CLI profile
      - "5556:5555"  # separate serial for CLI profile
    devices:
      - /dev/kvm
    environment:
      - QEMU_RAM=2048
      - QEMU_SMP=1
      - DISPLAY_MODE=nographic
      - QEMU_VIDEO=std
      - QEMU_STORAGE=ide
      - QEMU_NET=e1000
      - SERIAL_PORT=5555
      - SHARE_TAG=scripts
    stdin_open: true
    tty: true
    networks:
      - hurd-net

networks:
  hurd-net:
    driver: bridge
